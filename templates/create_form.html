{% load static %}
{% if io_form.errors %}
    <div class="alert alert-danger">
        <strong>表單錯誤：</strong>
        <ul>
            {% for field, errors in io_form.errors.items %}
                {% for error in errors %}
                    <li>{{ field }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
{% endif %}
    <div class="row">
        <div class="col-md-6 dropdown" >
            <form method="post" class="card crate-form" style="margin:10px;padding:10px;">
                <label>Zerojudge抓取：<input id="ZeroJudgeNumber"></input><button onclick="GetZeroJudge({{cid}})">GET</button></label> 
                {% csrf_token %}
                {{ problem_form.as_p }}
                {{ formset.management_form }}

                <label>測試資料輸入</label>
                <div id="formset-container">
                    {% for form in formset %}
                        <div class="formset-form">
                            <hr>
                            <div class="row">
                                <label id="input-output-number">#{{ forloop.counter }}</label>
                                {% for field in form %}
                                    
                                        <div class="form-group col-md-6" style="{%  if field.label != "輸入" and field.label != "輸出" %}display:none;{% endif%}">
                                            <label id="{{ field.id_for_label }}">{{ field.label }}</label>
                                            {{ field }}
                                        </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                            
            <button onclick="addFormset()">Add Formset</button> <!-- Add this line -->
                <button type="submit">Submit</button>
                
            </form>
        </div>
        <div class="col-md-6 card fix-div-right" >
                <embed src="{% static "latex/" %}{{cid}}/dom/problem.pdf" width="100%" height="100%" type="application/pdf">
        </div>
    </div>

<script>
    function GetZeroJudge(cid) {
        const number = document.getElementById("ZeroJudgeNumber").value;
        event.preventDefault();
        $.ajax({
            url: "/getZerojudge/" + cid ,
            type: "POST",
            data: {
                "ZeroJudgeNumber":number,
                "csrfmiddlewaretoken": "{{ csrf_token }}"
            },
            success: function (data) {
                const createDiv = $("#CreateForm")
                createDiv.html(data)

            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
                alert(thrownError);
            }
        });
    }

    function addFormset() {
        console.log("addFormset");
        event.preventDefault();
        // 找到表單集的總表單數量
        const totalForms = parseInt($('#id_inputoutput_set-TOTAL_FORMS').val());
        console.log(totalForms);
        // 複製第一個空白表單
        const newForm = $('#formset-container .formset-form:first').clone();

        // 替換克隆表單中的名稱，使其成為新的表單
        newForm.find(':input').each(function () {
            const name = $(this).attr('name').replace('-0-', '-' + totalForms + '-');
            $(this).attr('name', name).attr('id', name);
            $(this).val('');  // 清空表單的值，可根據需要調整
        });
        newForm.find('label').each(function () {
            const newFor = $(this).attr('id').replace('-0-', '-' + totalForms + '-');
            $(this).attr('for', newFor);

        });


        // 將新表單添加到容器中
        $('#formset-container').append(newForm);

        // 更新表單集的總表單數量
        $('#id_inputoutput_set-TOTAL_FORMS').val(totalForms + 1);
    }
</script>